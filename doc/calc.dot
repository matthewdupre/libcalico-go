digraph G {
size="7.5,10"
labeljust="l"
fontname=Helvetica;
node [fontname=Helvetica]
edge [fontname=Helvetica,fontsize=10]

    subgraph cluster0 {
    label="Datastore layer";

        Syncer [shape=box]
    }

    Syncer -> Dispatcher [label="typed KVs"]

    subgraph cluster1 {
    label="Calculation layer";
        subgraph {
            /* Put some padding either side of the Dispatcher. */
            rank=same; nodepadding1; Dispatcher; nodepadding2;
            nodepadding1 [style=invisible,fixedsize=true,width=3]
            nodepadding2 [style=invisible,fixedsize=true,width=3]
            nodepadding1 -> Dispatcher [style=invis];
            Dispatcher -> nodepadding2 [style=invis];
        }

        Dispatcher [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Dispatcher</font></td></tr>
          <tr><td><font point-size="10">Fans out updates</font></td></tr>
        </table>>, shape=none, margin=0]
        Dispatcher -> Resolver [label="endpoint, policy,\nprofile KVs"];
        Dispatcher -> PolicyResolver [label="policy, tier\nKVs"]

        Resolver [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Resolver</font></td></tr>
          <tr><td><font point-size="10">Orchestrates the IP set calculations</font></td></tr>
        </table>>, shape=none, margin=0];
        Resolver -> ActiveRulesCalculator [label="local\nendpoint KVs"];
        ActiveRulesCalculator [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Active rules calculator</font></td></tr>
          <tr><td><font point-size="10">Calculates which policies/profiles are<br/>active on this host.</font></td></tr>
        </table>>, shape=none, margin=0];
        ActiveRulesCalculator -> RuleScanner [label="active rule\nupdates"];
        ActiveRulesCalculator -> PolicyResolver [label="policy match\nupdates"];

        LabelInheritanceIndex [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Label inheritance index</font></td></tr>
          <tr><td><font point-size="10">Combines profile labels with endpoint labels;<br/>indexes labels against selectors.</font></td></tr>
        </table>>, shape=none, margin=0];
        Resolver -> LabelInheritanceIndex [label="endpoint, profile\nlabels"];
        LabelInheritanceIndex -> IpsetCalculator [label="selector\nmatch"];

        RuleScanner [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Rule scanner</font></td></tr>
          <tr><td><font point-size="10">Scans rules, extracts<br/>referenced selectors<br/>and tags.</font></td></tr>
        </table>>, shape=none, margin=0];

        RuleScanner -> LabelInheritanceIndex [label="selector\n(in)active"];
        RuleScanner -> "tags.Index" [label="tag\n(in)active"];

        PolicyResolver [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Policy resolver</font></td></tr>
          <tr><td><font point-size="10">Calculates the active<br/>tiers and policies<br/>for each active endpoint.</font></td></tr>
        </table>>, shape=none, margin=0];


        "tags.Index" [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Tag index</font></td></tr>
          <tr><td><font point-size="10">Calculates the endpoints in each active tag.</font></td></tr>
        </table>>, shape=none, margin=0];

        Resolver -> "tags.Index" [label="endpoint, tags"];
        "tags.Index" -> IpsetCalculator [label="tag match\nupdates"];

        IpsetCalculator [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Ipset calculator</font></td></tr>
          <tr><td><font point-size="10">Given the endpoints and their IPs,<br/>calculates the IP memberships of th<br/>IP sets. Handles duplicate IPs.</font></td></tr>
        </table>>, shape=none, margin=0];

        Resolver -> IpsetCalculator [label="endpoint IP\nupdates"];

    }

    ActiveRulesCalculator -> FelixConnection [label="active policy,\nprofile KVs"];
    RuleScanner -> FelixConnection [label="selector\n(in)active"];
    IpsetCalculator -> FelixConnection [label="IP added/removed"];
    PolicyResolver -> FelixConnection [label="per-endpoint\ntiers, policies"];


    subgraph cluster2 {
    label="Felix layer";

        FelixConnection [label=<<table BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
          <tr><td><font point-size="14">Felix connection</font></td></tr>
          <tr><td><font point-size="10">Reads/writes the Felix socket.  Translates<br/>updates to Felix typed message format.</font></td></tr>
        </table>>, shape=none, margin=0];
    }


    FelixConnection -> Felix [label="messagepack"];
    Felix [shape=box, label="Felix front-end"];
}
